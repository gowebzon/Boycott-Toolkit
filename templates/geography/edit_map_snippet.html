<!-- pull all the map stuff from groundtruth -->
<script type="text/javascript" src="http://groundtruth.media.mit.edu/media/openlayers/OpenLayers.js"></script>
<script type="text/javascript" src="http://groundtruth.media.mit.edu/media/openlayers/customLayerSwitcher.js"></script>
<script type="text/javascript" src="http://groundtruth.media.mit.edu/media/openlayers/cloudmade.js"></script>
<script type="text/javascript" src="http://groundtruth.media.mit.edu/media/map/styles.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}map/map.js"></script>

<style>
#map {
    float:left;
    clear:left;
    width:400px;
    height:400px;
}

#layerswitcher {
    float:left;
    width:150px;
    height:400px;
}

.olControlAttribution {
  position:absolute;
  bottom:0px;
  left:0px;
  font-size:10pt;
}
</style>


{% for field in form %}
{% ifequal field.name "center" %}
<div id="map"></div>
<div id="layerswitcher"></div>
{%endifequal%}

<div class="fieldWrapper">
	<div class="fieldError">{{ field.errors }}</div>
	{%if field.is_required %}<b>{%endif%}
	<div class="fieldLabel">{{ field.label_tag }}:</div>
	{%if field.is_required %}</b>{%endif%}
	<div class="field">{{ field }}</div>
	<div class="fieldHelpText">{{ field.help_text|safe }}</div>
</div>
{% endfor %}



<script type="text/javascript">
     //DECONFLICT JQUERY AND OPENLAYERS
     $ = jQuery.noConflict();
     
     $(document).ready(function() {
        initMap();
        
        result = false;
        
        $('#id_map-name').autocomplete("/autocomplete/geocode/", { multiple: false, delay:100 });
        $("#id_map-name").result(function(event, data, formatted) {
          if (data[1]) { //we have a real response
            var searchResult = eval('('+data[2]+')'); //third field has the geojson, turn it into an object
            var coords = searchResult.geometry.coordinates;
            //get the projection from the geojson
            var theProj = new OpenLayers.Projection(searchResult.crs.properties.name);
            var lonlat = new OpenLayers.LonLat(coords[0], coords[1]);
            result = lonlat.transform(theProj,sphericalMercator);
            console.log(result);
            //TODO: determine zoom dynamically
            map.setCenter(result,10);
          } else { //it's a header

          }
            
        });
        
        /* Make the map info fields un-editable */
        $('#id_map-zoom').attr('readonly',true);
        $('#id_map-center').attr('readonly',true);
        
        /* JQuery to pull map info from iframe and save it to form fields */
        function mapCoordsToFormFields(e) {
          $('#id_map-zoom').val(map.zoom);
          center = map.center.clone();
          center.transform(sphericalMercator,gps);
          $('#id_map-center').val(center.lon + "," + center.lat);
        }
        map.events.register( 'moveend', this, mapCoordsToFormFields);
      });

</script>